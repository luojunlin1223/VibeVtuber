# ADR-001: Range Remapping for Live2D Parameter Mapping

**Date:** 2026-02-15

**Status:** Accepted

## Context

MediaPipe outputs blendshape values in the range 0-1, representing facial feature intensities. However, the actual range of values for many parameters is often smaller than the theoretical maximum. For example:

- `jawOpen` typically maxes out at 0.6-0.7 in practice, not 1.0
- Eye movements may have different practical ranges
- Different Live2D models expect different value ranges

Without range remapping, this leads to:
- Underutilized Live2D parameter ranges (mouth never fully opens)
- Inconsistent sensitivity across different facial features
- Difficulty creating dead zones to filter noise
- No way to enhance subtle expressions

## Decision

Add a **range remapping system** to `ParameterMapping` with the following features:

1. **Input Range** (`inputMin`, `inputMax`): Define the expected range from MediaPipe
2. **Output Range** (`outputMin`, `outputMax`): Define the target range for Live2D
3. **Smoothstep Option** (`useSmoothstep`): Apply smooth S-curve interpolation
4. **Separate from Clamping**: Range remapping happens before final clamping

**Processing Pipeline:**
```
Source Value → Invert (optional) → Range Remap (optional) →
Multiplier/Offset → Clamp (optional) → Temporal Smooth (optional) → Output
```

**Remapping Formula:**
```csharp
// Normalize input to 0-1
float t = Mathf.InverseLerp(inputMin, inputMax, value);

// Apply smoothstep if enabled
if (useSmoothstep)
    t = Mathf.SmoothStep(0, 1, t);

// Map to output range
value = Mathf.Lerp(outputMin, outputMax, t);
```

## Alternatives Considered

### 1. Simple Multiplier Only
**Pros:** Simple, already exists
**Cons:** Cannot create dead zones, cannot map asymmetric ranges

### 2. Pre-processing in Python
**Pros:** Centralized logic
**Cons:** Not model-specific, requires Python code changes for each model

### 3. Post-processing Script
**Pros:** Flexible
**Cons:** Extra component, harder to debug, duplicates logic

## Consequences

### Positive
- ✅ Jaw opening can be normalized (0-0.6 input → 0-1.0 output)
- ✅ Eye movements can be calibrated to model's range
- ✅ Dead zones can filter noise (e.g., ignore browInnerUp < 0.2)
- ✅ Subtle expressions can be enhanced (0-0.5 input → 0-1.0 output)
- ✅ Smoothstep creates natural easing for eye movements and expressions
- ✅ All configuration in Unity Inspector, no code changes
- ✅ Backward compatible (disabled by default)

### Negative
- ⚠️ More complexity in parameter mapping UI
- ⚠️ Users need to understand input vs output ranges
- ⚠️ Potential for misconfiguration if ranges are inverted

### Neutral
- Inspector UI updated with ShowIf conditions to reduce clutter
- Documentation added (PARAMETER_MAPPING_GUIDE.md)
- Examples provided for common use cases

## Implementation Details

**New Fields in ParameterMapping:**
```csharp
public bool useRemapping = false;
public float inputMin = 0f;
public float inputMax = 1f;
public float outputMin = 0f;
public float outputMax = 1f;
public bool useSmoothstep = false;
```

**New Constructor:**
```csharp
public ParameterMapping(string source, string target,
    float inMin, float inMax, float outMin, float outMax,
    bool smoothstep = false)
```

## Examples

### Jaw Opening (Normalization)
```csharp
new ParameterMapping("jawOpen", "ParamMouthOpenY",
    inMin: 0f, inMax: 0.6f,  // Real max is 0.6
    outMin: 0f, outMax: 1.0f,
    smoothstep: true)
```

### Eye Y-Axis (Difference + Remapping)
```csharp
new ParameterMapping(
    sources: new List<string> { "eyeLookUpLeft", "eyeLookDownLeft" },
    target: "ParamEyeBallY",
    mode: CombineMode.Difference  // Up - Down
)
{
    useRemapping = true,
    inputMin = -1f,   // Difference range
    inputMax = 1f,
    outputMin = -30f, // Live2D angle range
    outputMax = 30f,
    useSmoothstep = true
}
```

### Eyebrow (Dead Zone)
```csharp
new ParameterMapping("browInnerUp", "ParamBrowLY",
    inMin: 0.2f,  // Ignore 0-0.2 (noise)
    inMax: 1.0f,
    outMin: 0f,
    outMax: 1.0f,
    smoothstep: false)
```

## Related Documents
- PARAMETER_MAPPING_GUIDE.md (comprehensive usage guide)
- Live2DFaceController.cs (implementation)
